name: PyPI üì¶ Distribution

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.name }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - {
              os: windows-2019,
              arch: x64,
              python-ver: '3.8',
              name: 'win_amd64'
            }
          # - {
          #     os: windows-2019,
          #     arch: x32,
          #     python-ver: '3.8',
          #     name: 'win32'
          #   }
          - {
              os: ubuntu-latest,
              arch: x64,
              python-ver: '3.8',
              name: 'manylinux2014_x86_64'
            }
          # - {
          #     os: ubuntu-latest,
          #     arch: x32,
          #     python-ver: '3.8',
          #     name: 'manylinux2014_i686'
          #   }
          # - {
          #     os: ubuntu-latest,
          #     arch: x64,
          #     python-ver: '3.8',
          #     name: 'sdist'
          #   }
          - {
             os: macos-latest,
             arch: x64,
             python-ver: '3.8',
             name: 'macos_x86_64'
            }

    steps:
    - uses: actions/checkout@v3

    - name: 'üêç Set up Python'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.config.python-ver }}

    - name: 'üõ†Ô∏è Install dependencies'
      run: |
        pip install build

    - name: 'üöß Build distribution'
      run: |
        cd bindings/python
        python -m build -w

    - name: 'üì§ Upload artifact'
      uses: actions/upload-artifact@v3
      with:
         path: ${{ github.workspace }}/bindings/python/dist/*

  publish:
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags')
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: artifact
          path: dist

      - name: 'üì¶ Publish distribution to PyPI'
        uses: pypa/gh-action-pypi-publish@master
        with:
          user: __token__
          password: ${{ secrets.pypi_pass }}
